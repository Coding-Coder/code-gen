var FDCalendar=function(a){FDLib.implement(this,FDControl);this.options=FDLib.util.apply(this.getOptions(),a);this.dateUtil=FDLib.date;this.today=new Date();this.date=new Date();this.calendarDiv=this.buildCalandarPanel();this.table=this.buildCalendarTable();this.thead=this.table.createTHead();this.tbody=document.createElement(FDTag.TBODY);this.tfoot=this.table.createTFoot();this.table.appendChild(this.tbody);this.yearSelect=null;this.monthSelect=null;this.selectedTD;this._buildCalendarBody();this.render()};FDCalendar.FORMAT_YMD="yyyy-MM-dd";FDCalendar.FORMAT_YMDHMS="yyyy-MM-dd hh:mm:ss";FDCalendar.MONTH_ITEMS=[{text:"一月",value:"1"},{text:"二月",value:"2"},{text:"三月",value:"3"},{text:"四月",value:"4"},{text:"五月",value:"5"},{text:"六月",value:"6"},{text:"七月",value:"7"},{text:"八月",value:"8"},{text:"九月",value:"9"},{text:"十月",value:"10"},{text:"十一月",value:"11"},{text:"十二月",value:"12"}];FDCalendar.prototype={getOptions:function(){return{domId:null,weekTextArr:["日","一","二","三","四","五","六"],format:FDCalendar.FORMAT_YMD,onclick:null,onclear:null,dayRender:function(b,a){return a}}},buildCalandarPanel:function(){var a=document.createElement(FDTag.DIV);a.className="ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all ui-shadow";a.style.display="none";return a},show:function(a){this.setValue(a);this.calendarDiv.style.display="block"},getCalendarDom:function(){return this.calendarDiv},hide:function(){this.calendarDiv.style.display="none"},setValue:function(a){var b;if(a){b=this.dateUtil.parse(a)}else{b=new Date()}this.setValueDate(b)},setValueDate:function(a){this.date=a;this.refresh()},setYearRefresh:function(a){this.setYear(a);this.refresh()},setMonthRefresh:function(a){this.setMonth(a);this.refresh()},getValue:function(){return this.dateUtil.format(this.date,this.options.format)},getYear:function(){return this.date.getFullYear()},getMonth:function(){return this.date.getMonth()+1},getDate:function(){return this.date.getDate()},getHours:function(){return this.date.getHours()},getMinutes:function(){return this.date.getMinutes()},setYear:function(a){this.date.setYear(a)},setMonth:function(a){this.date.setMonth(a-1)},setDate:function(a){this.date.setDate(a)},setHours:function(a){this.date.setHours(a)},setMinutes:function(a){this.date.setMinutes(a)},setSeconds:function(a){this.date.setSeconds(a)},refresh:function(){this._refreshBody();this._buildCalendar()},render:function(){if(FDRight.checkByCode(this.options.operateCode)){var a=FDLib.getEl(this.options.domId)||document.body;a.appendChild(this.calendarDiv)}},getYMDData:function(){return{year:this.getYear(),month:this.getMonth(),date:this.getDate()}},_buildCalendarBody:function(){var a=this.buildYearMonthSelector();this.calendarDiv.appendChild(a);this.appendWeekTextRow(this.thead);this.calendarDiv.appendChild(this.table);var b=this.buildButtonsDiv();this.calendarDiv.appendChild(b)},_refreshBody:function(){FDLib.dom.removeDom(this.tbody);this.tbody=document.createElement(FDTag.TBODY);this.table.appendChild(this.tbody);this._initOnclickEvent();this._initMouseEvent()},buildCalendarTable:function(){var a=document.createElement(FDTag.TABLE);a.className="ui-datepicker-calendar";return a},buildButtonsDiv:function(){var a=document.createElement(FDTag.DIV);a.className="ui-datepicker-header";a.style.textAlign="center";var d=this;var c=new FDButton({text:"今天",onclick:function(){d.setToday()}});var b=new FDButton({text:"清空",onclick:function(){d._runOnclearHandler()}});c.renderToDom(a);b.renderToDom(a);return a},setToday:function(){this.setValueDate(new Date());this._runOnclickHandler()},_initOnclickEvent:function(){var a=this;FDLib.event.addBatchEvent({superDom:this.tbody,tagName:"SPAN",eventName:"click",handler:function(c){if(c&&c.innerHTML){var b=parseInt(c.innerHTML);a.onClickDate(b,c);a._runOnclickHandler()}}})},_highlightTD:function(a){FDLib.dom.addClass(a,"ui-state-hover")},_unhighlightTD:function(a){FDLib.dom.removeClass(a,"ui-state-hover")},_initMouseEvent:function(){var a=this;FDLib.event.addBatchEvent({superDom:this.tbody,tagName:"SPAN",eventName:"mouseover",handler:function(b){a._highlightTD(b)}});FDLib.event.addBatchEvent({superDom:this.tbody,tagName:"SPAN",eventName:"mouseout",handler:function(b){a._unhighlightTD(b)}})},onClickDate:function(a,b){this.setDate(a);this.activeTD(b.outer)},_runOnclickHandler:function(){var a=this.options.onclick;if(FDLib.util.isFunction(a)){a(this.getValue(),this)}},_runOnclearHandler:function(){var a=this.options.onclear;if(FDLib.util.isFunction(a)){a(this.getValue(),this)}},activeTD:function(b){var a=null;if(this.selectedTD){this.selectedTD.className="";a=this.selectedTD.inner;FDLib.dom.removeClass(a,"ui-state-highlight ui-state-active")}FDLib.dom.addClass(b,"ui-datepicker-days-cell-over  ui-datepicker-current-day ui-datepicker-today");a=b.inner;FDLib.dom.addClass(a,"ui-state-highlight ui-state-active");this.selectedTD=b},_buildCalendar:function(){var j=this;var b=this.dateUtil.getEndDate(this.getYear(),this.getMonth());var g=new Date(this.getYear(),this.getMonth()-1,1);var c=g.getUTCDay();var e=new Date();var a=1;var f=0;var h=this.tbody.insertRow(f++);for(var d=0;d<=c;d++){h.insertCell(d)}for(var d=c+1;d<=6;d++){this._buildTD(h,d,a++)}while(a<=b){var k=this.tbody.insertRow(f++);for(var d=0;d<=6&&a<=b;d++){this._buildTD(k,d,a++)}}this.initYearMonthSelect()},_buildTD:function(d,b,a){var e=d.insertCell(b);var c=document.createElement(FDTag.SPAN);c.innerHTML=this.options.dayRender(c,a);c.className="ui-state-default";c.style.textAlign="center";c.outer=e;e.inner=c;e.appendChild(c);e.style.cursor="pointer";e.style.textAlign="center";if(this._isReachToToday(a)){e.title="今天"}if(this._isSelectedDay(e)){this.activeTD(e)}},_isReachToToday:function(a){return this.today.getDate()==a&&this.getMonth()==this.today.getMonth()+1&&this.today.getFullYear()==this.getYear()},_isSelectedDay:function(b){var a=this.getDateByTD(b);return this.getDate()==a},getDateByTD:function(c){var b=c.inner;var a=null;if(b){a=parseInt(b.innerHTML)||1}return a||1},buildYearMonthSelector:function(){var a=document.createElement(FDTag.DIV);a.className="ui-datepicker-header ui-widget-header ui-helper-clearfix ui-corner-all";this.appendPrevMonthButton(a);this.appendNextMonthButton(a);this.appendYearMonthSelect(a);return a},appendPrevMonthButton:function(e){var c=this;var b=document.createElement(FDTag.A);b.className="ui-datepicker-prev ui-corner-all";var d=document.createElement(FDTag.SPAN);d.className="ui-icon ui-icon-circle-triangle-w";d.title="上月";FDLib.event.addEvent(d,"click",function(){var a=c.getMonth()-1;var f=c.getYear();if(a<1){f--}c.setYearMonth(f,a)});b.appendChild(d);e.appendChild(b)},appendNextMonthButton:function(e){var c=this;var b=document.createElement(FDTag.A);b.className="ui-datepicker-next ui-corner-all";var d=document.createElement(FDTag.SPAN);d.className="ui-icon ui-icon-circle-triangle-e";d.title="下月";FDLib.event.addEvent(d,"click",function(){var a=c.getMonth()+1;var f=c.getYear();if(a>12){f++}a=a>12?1:a;c.setYearMonth(f,a)});b.appendChild(d);e.appendChild(b)},setYearMonth:function(a,b){this._setNextMonthDate(a,b);this.setMonth(b);this.setYear(a);this.refresh()},appendYearMonthSelect:function(b){var a=this;var c=document.createElement(FDTag.DIV);c.className="ui-datepicker-title";this.yearSelect=new FDSelectBox({showDefault:false,items:this.buildYearItems()});this.monthSelect=new FDSelectBox({showDefault:false,items:FDCalendar.MONTH_ITEMS});this.yearSelect.addEvent("change",function(){a.setYearRefresh(this.value)});this.monthSelect.addEvent("change",function(){a.setMonthRefresh(this.value)});this.yearSelect.renderToDom(c);this.monthSelect.renderToDom(c);b.appendChild(c)},buildYearItems:function(){var a=this.options.yearItems||[];var b=this.getYear();for(var c=-10;c<=10;c++){var d=b+c;a.push({text:d,value:d})}return a},_setNextMonthDate:function(c,b){if(this.isEndDate()){var d=this._getCurrentEndDate();var a=this.dateUtil.getEndDate(c,b);this.setDate(Math.min(d,a))}},isEndDate:function(){var a=this._getCurrentEndDate();return this.getDate()==a},_getCurrentEndDate:function(){return this.dateUtil.getEndDate(this.getYear(),this.getMonth())},appendWeekTextRow:function(c){var b=this.options.weekTextArr;var a=c.insertRow(0);FDLib.util.each(b,function(f,d){var e=document.createElement(FDTag.TH);if(d==0||d==b.length-1){e.className="ui-datepicker-week-end"}e.innerHTML="<span>"+f+"</span>";a.appendChild(e)})},initYearMonthSelect:function(){this.yearSelect.setValue(this.getYear());this.monthSelect.setValue(this.getMonth())}};